<?php
 require_once( '../common/config.ini' ); require_once( '../common/users.php' ); session_start(); $usersObj = new users(); $err = array(); $form_data = array(); if( $_SERVER['REQUEST_METHOD'] == 'POST' || $_SERVER['REQUEST_METHOD'] == 'GET' ) { $usersObj->get_data($_REQUEST, $form_data); (!isset($form_data['status'])) ? $form_data['status'] = '':NULL; (!isset($form_data['email'])) ? $form_data['email'] = '':NULL; (!isset($form_data['password'])) ? $form_data['password'] = '':NULL; $err['email'] = ''; } switch ($form_data['status']) { case 'login': if( !empty( $form_data['email'] )) { $usersObj->check_mailadd( $form_data['email'] ); } if( !empty( $form_data['password'] )) { $usersObj->check_pw( $form_data['password'] ); } $usersObj->check_login(); $err = $usersObj->get_err(); if( empty( $err )) { if( $usersObj->db_login( $form_data['email'], sha1($form_data['password']), $auth=ADMIN_ROLL, $userdata)) { $_SESSION = array(); $usersObj->set_auth_session( $userdata ); if( !empty( $userdata['modified'] )) { require_once( 'main.php'); } else { header( 'Location:'.URL.'/admin/users/index.php?status=admin' ); } exit; } else { $err['all'] = 'ユーザー情報が間違っています。'; } } require_once( 'login.php' ); break; case 'logout': $usersObj->session_dell(); header( 'Location:'.URL.'/admin/' ); break; default: if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { require_once( 'main.php'); exit; } } require_once( 'login.php'); break; } ?>