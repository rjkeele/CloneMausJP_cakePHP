<?php
 require_once( '../../common/config.ini' ); require_once( '../../common/users.php' ); require_once( '../../common/logs.php' ); session_start(); $usersObj = new users(); $logsObj = new logs(); if( $usersObj->get_auth_session( $_SESSION, $user )) { if( $usersObj->db_login( $user['email'], $user['password'], $auth=ADMIN_ROLL, $user )) { session_regenerate_id( TRUE ); } else { $userObj->session_dell(); } $userObj = NULL; } else { header( 'Location:'.URL.'/admin/' ); } if( $_SERVER['REQUEST_METHOD'] == 'POST' || $_SERVER['REQUEST_METHOD'] == 'GET' ) { $logsObj->get_data($_REQUEST, $form_data); (!isset($form_data['status'])) ? $form_data['status'] = '':NULL; } switch ($form_data['status']) { case 'view': if( !empty( $form_data['story_no'] )) { if( !$logsObj->get_step_mail_log( $form_data['id'], $data )) { $message = "履歴がありません。"; } } else { if( !$logsObj->get_extra_mail_log( $form_data['id'], $data )) { $message = "履歴がありません。"; } } $form_data['status'] = 'view'; require_once( 'view.php' ); break; case 'log_delete_flg': if( $_SERVER['REQUEST_METHOD'] == 'POST' && ( $form_data['term'] !== '' )) { $logsObj->db_delete_flg_step_log( $form_data['term'] ); $logsObj->db_delete_flg_extra_log( $form_data['term'] ); header( 'Location:'.URL.'/admin/logs/' ); } break; case 'log_delete': if( $_SERVER['REQUEST_METHOD'] == 'POST' & !empty( $form_data['term'] )) { $logsObj->db_delete_step_log( $form_data['term'] ); $logsObj->db_delete_extra_log( $form_data['term'] ); header( 'Location:'.URL.'/admin/logs/' ); } break; case 'view_mail_sum': break; default: $result = FALSE; if( !$logsObj->get_all_step_mail_log( $step_data )) { $message = "ステップメール履歴がありません。"; } else { $data = $step_data; $result1 = TRUE; } if(!empty($data)){ foreach( $data as $id => $log ) { $logsObj->check_send_flg( $log['group_id'], $count ); $data[$id]['on'] = $count['on']; $data[$id]['done'] = $count['done']; $data[$id]['err'] = $count['err']; } } $form_data['status'] = 'default'; require_once( 'list.php' ); break; } ?>