<?php
 require_once( '../../common/config.ini' ); require_once( '../../common/users.php' ); require_once( '../../common/mails.php' ); require_once( '../../common/headers.php' ); require_once( '../../common/footers.php' ); require_once( '../../common/settings.php' ); require_once( '../../common/logs.php' ); $mailsObj = new mails(); $headersObj = new headers(); $footersObj = new footers(); $settingsObj = new settings(); $logsObj = new logs(); $usersObj = new users(); $group_id = date('YmdHis'); $settingsObj->get_all_setting( $setting ); $users = array(); if($mailsObj->get_stepmail_count( $cnt )){ $usersObj->update_users_send_date(1); } else { $usersObj->update_users_send_date(0); } $mailsObj->get_stepmail_users_list( $users ); $resend_users = array(); $mailsObj->get_stepmail_resend_users_list($resend_users); $users_list = array_merge($users, $resend_users); if (!empty($users_list)){ foreach ($users_list as $index => $user) { $mailsObj->get_stepmail($user['step_mail_id'], $data); $error_count = $logsObj -> get_step_mail_error_count($user['id'], $data); if ($error_count >= $setting['send_err_num']) { if ($setting['send_err'] === "0") { $usersObj -> db_delflag_user(FLG_ERR, $user['id']); continue; } else { $usersObj -> db_delete_user($user['id']); continue; } } $headersObj->get_header($data['header_id'], $header); $footersObj->get_footer($data['footer_id'], $footer); $subject = $data['title']; $message = $header['header']; $message .= $data['contents']; $message .= $footer['footer']; $data['title'] = $mailsObj->txtReplace( $subject, $user); $data['contents'] = $mailsObj->txtReplace( $message, $user); $data['send_flg'] = 99; $data['group_id'] = $group_id; $logsObj->db_add_step_mail_log($data, $user['id']); } } $mailsObj->send_split_step_mail( $setting ); ?>